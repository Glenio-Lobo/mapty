<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: mapty.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: mapty.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @ts-check
'use strict';


// @ts-ignore
import 'core-js/stable';
// @ts-ignore
import 'regenerator-runtime/runtime';
// @ts-ignore
import { async } from 'regenerator-runtime';

//Prettier-Ignore faz com que a formatação automática do prettier ignore a linha seguinte
// prettier-ignore
// @ts-ignore
const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

const inputForm = document.querySelector('.workout__form');
const distanceInput = document.querySelector('.workout__input--distance');
const durationInput = document.querySelector('.workout__input--duration');
const cadenceInput = document.querySelector('.workout__input--cadence');
const gainInput = document.querySelector('.workout__input--gain');
const selectionInput = document.querySelector('.workout__select');
const workoutContainer = document.querySelector('.workout');

/** App Class */
class App{
  /** @property {Array&lt;Workout>} - Represents all the workouts */
  #workouts = [];
  /** @property {HTMLElement} - Leaflet map */
  #map;
  /** @property {MouseEvent} - Mouse Event of the Newest Marker*/
  #currentMapEvent;

  /**
   * Creates an App
   */
  constructor(){
    // this.reset();
    this.#getPosition();
    this.#getLocalStorage();
    // @ts-ignore
    inputForm.addEventListener('submit', this.#newWorkout.bind(this));
    // @ts-ignore
    selectionInput.addEventListener('change', this.#toggleElevationField);
    // @ts-ignore
    workoutContainer.addEventListener('click', this.#moveToPopup.bind(this))
  }

  /** 
   * Get the user geolocation
   * @property {Function}
   * @returns {void}
   */
  #getPosition(){
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        this.#loadMap.bind(this), //Sucesso
        () => { //Caso falhe.
          alert('Não foi possível obter sua localização.');
        }
      );
    }
  }

  /**
   * Load the map on the user position
   * @property {Function}
   * @param {GeolocationPosition} position
   * @return {void}
   */
  #loadMap(position){
    const [latitude, longitude] = [position.coords.latitude, position.coords.longitude];

    //Renderiza o Mapa
    // @ts-ignore
    this.#map = L.map('map').setView([latitude, longitude], 13);

    // @ts-ignore
    const hotTileLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
      {
        attribution:
          '&amp;copy; &lt;a href="https://www.openstreetmap.org/copyright">OpenStreetMap&lt;/a> contributors, Tiles style by &lt;a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team&lt;/a> hosted by &lt;a href="https://openstreetmap.fr/" target="_blank">OpenStreetMap France&lt;/a>',
      }
    ).addTo(this.#map);

    this.#map.on('click', this.#showForm.bind(this));

    this.#workouts.forEach( workout => {
      this.#renderWorkoutMarker(workout); //Render the markers after load map
    })
  }

  #toggleElevationField(){
    // @ts-ignore
    gainInput.closest('.workout__group').classList.toggle('hidden');
    // @ts-ignore
    cadenceInput.closest('.workout__group').classList.toggle('hidden');
  }

  /**
   * Add a new Workout
   * @param {Event} e 
   * @returns {void}
   */
  #newWorkout(e){
    e.preventDefault();

    /* Helper Functions */

    /* Verify if its a Number and Positive*/
    const isNumberAndPositive = (...arr) =>
      arr.every(value => Number.isFinite(value) &amp;&amp; value > 0);

    /* End of Helper Functions */

    // @ts-ignore
    const typeInput = selectionInput.value;
    // @ts-ignore
    const distance = Number(distanceInput.value);
    // @ts-ignore
    const duration = Number(durationInput.value);
    let workout;

    //Running Case
    if(typeInput === 'running'){
      // @ts-ignore
      const cadence = Number(cadenceInput.value);

      //Validação das entradas
      if(!isNumberAndPositive(distance, duration, cadence)) return alert('Input must be a positive number.');
      workout = new Running(distance, duration, this.#currentMapEvent.latlng, cadence);
    }
    
    //Cycling case
    if(typeInput === 'cycling'){
      // @ts-ignore
      const gain = Number(gainInput.value);

      //Validação das entradas
      if(!isNumberAndPositive(distance, duration, gain)) return alert('Input must be a positive number.');
      workout = new Cycling(distance, duration, this.#currentMapEvent.latlng, gain);
    }

    this.#workouts.push(workout);
    // @ts-ignore
    this.#renderWorkout(workout);
    // @ts-ignore
    this.#renderWorkoutMarker(workout);
    this.#setLocalStorage();
    this.#hideForm();

  }

  /**
   * Renders the workouy
   * @param {Workout} workout 
   * @returns {void}
   */
  #renderWorkout(workout){
    const numberFormater = number => {
      let dollarFormat = Intl.NumberFormat('en', {
        style: 'decimal',
        minimumFractionDigits: 1,
      });
      return dollarFormat.format(number);
    }

    // @ts-ignore
    const html = `&lt;div class="workout__item workout__card workout__card--${workout.name}" data-id= "${workout.id}">
                      &lt;h1 class="workout__title">
                          ${workout.description}
                      &lt;/h1>

                      &lt;div class="workout__data">
                          &lt;div class="workout__info">
                              &lt;span class="workout__info__icon">🚴‍♀️&lt;/span>
                              &lt;span class="workout__info__value">${workout.distance}&lt;/span>
                              &lt;span class="workout__info__unit">km&lt;/span>
                          &lt;/div>

                          &lt;div class="workout__info">
                              &lt;span class="workout__info__icon">⏱&lt;/span>
                              &lt;span class="workout__info__value">${workout.duration}&lt;/span>
                              &lt;span class="workout__info__unit">min&lt;/span>
                          &lt;/div>

                          &lt;div class="workout__info">
                              &lt;span class="workout__info__icon">⚡️&lt;/span>
                              &lt;span class="workout__info__value">
                              ${workout.
// @ts-ignore
                              name === 'running' ? numberFormater(workout.pace) : numberFormater(workout.speed)}
                              &lt;/span>
                              &lt;span class="workout__info__unit">
                              ${workout.
// @ts-ignore
                              name === 'running' ? 'MIN/KM' : 'KM/H'}
                              &lt;/span>
                          &lt;/div>

                          &lt;div class="workout__info">
                              &lt;span class="workout__info__icon">
                              ${workout.
// @ts-ignore
                              name === 'running' ? '🦶🏼' : '⛰'}
                              &lt;/span>
                              &lt;span class="workout__info__value">
                              ${workout.
// @ts-ignore
                              name === 'running' ? workout.cadence : workout.gain}
                              &lt;/span>
                              &lt;span class="workout__info__unit">
                              ${workout.
// @ts-ignore
                              name === 'running' ? 'SPM' : 'M'}
                              &lt;/span>
                          &lt;/div>
                      &lt;/div>
                  &lt;/div>`;
    
    // @ts-ignore
    inputForm.insertAdjacentHTML('afterend', html);
  }

  /**
   * Render the workout marker
   * @property {Function}
   * @param {Workout} workout 
   * @returns {void}
   */
  #renderWorkoutMarker(workout){

    let popupOptions = {
      maxWidth: 350, minWidth: 100, 
      autoClose: false, closeOnClick: false, 
      // @ts-ignore
      className: `popup--${workout.name}`,
      // @ts-ignore
      content: (workout.name === 'running' ? '🏃‍♂️ ' : '🚴‍♀️ ') + workout.description,
    };

    // @ts-ignore
    let marker = L.marker(workout.coords);
    // @ts-ignore
    marker.addTo(this.#map).bindPopup(L.popup(popupOptions)).openPopup();
  }

  /**
   * Shows the creation workout form
   * @property {Function}
   * @param {MouseEvent} mapEvent 
   * @returns {void}
   */
  #showForm(mapEvent){
    this.#currentMapEvent = mapEvent;

    // @ts-ignore
    if(inputForm.classList.contains('hidden')){
      // @ts-ignore
      inputForm.classList.remove('hidden');
    }

    // @ts-ignore
    distance.focus();
  }

  /**
   * Hides the markout form
   * @property {Function}
   */
  #hideForm(){
    // @ts-ignore
    distanceInput.value = durationInput.value = gainInput.value = cadenceInput.value = '';
    // @ts-ignore
    inputForm.style.display = 'none';
    // @ts-ignore
    inputForm.classList.add('hidden');
    // @ts-ignore
    setTimeout(()=>inputForm.style.display = 'grid', 500);
  }

  /**
   * Moves the user to the popup linked to the clicked workout
   * @param {Event} e 
   * @returns {void}
   */
  #moveToPopup(e){
    // @ts-ignore
    const actualWorkout = e.target.closest('.workout__card');
    
    if(!this.#map) return;
    if(!actualWorkout) return;

    const workoutTarget = this.#workouts.find( 
      (val) => val.id === actualWorkout.dataset.id);
    
    
    this.#map.setView(workoutTarget.coords, 13, 
      {
        animate: true,
        pan: {
          duration: 1,
        }
      }
    );
  }
  
  /**
   * @property {Function} - Adds the workouts to the local Storage
   */
  #setLocalStorage(){
    localStorage.setItem('workouts', JSON.stringify(this.#workouts));
  }

  /** 
   * Get all the locally stored workouts
   * @property {Function}
   * @returns {void}
   * */
  #getLocalStorage(){
    // @ts-ignore
    const stored = JSON.parse(localStorage.getItem('workouts'));

    if(!stored) return;

    this.#workouts = stored;

    this.#workouts.forEach( workout => {
      this.#renderWorkout(workout);
      // this.#renderWorkoutMarker(workout);
    })
  }

  /**
   * Removes workouts from local storage
   */
  reset(){
    localStorage.removeItem('workouts');
    // location.reload();
    // window.stop();
  }
}

/** Workout Class */
class Workout{
  
  /**
   * Creates a new workout object
   * @param {number} distance 
   * @param {number} duration 
   * @param {LatLng} coords - Leaflet Object LatLng
   */
  constructor(distance, duration, coords){
    /** @property {number} */
    this.id = (Date.now() + '').slice(-10);
    /** @property {Date} */
    this.date = new Date();
    /** @property {number} */
    this.distance = distance; // km
    /** @property {number} */
    this.duration = duration; // min
    /** @property {LatLng} */
    this.coords = coords; // [lat, long]
  }

  /**
   * Set the workout description
   */
  setDescription(){
    const dataFormater = date => {
      const options = { month: 'long', day: 'numeric' };
      // @ts-ignore
      return new Intl.DateTimeFormat('en', options).format(date);
    }

    // @ts-ignore
    this.description = `${this.name.replace(this.name[0], this.name[0].toUpperCase())} on
                        ${dataFormater(this.date)}`;
  }
}

/**
 * Running Class
 * @extends Workout
 */
class Running extends Workout{
  /** @property {string} name Workout name */
  name = 'running';

   /**
   * Creates a new Running object
   * @param {number} distance 
   * @param {number} duration 
   * @param {LatLng} coords - Leaflet Object LatLng
   * @param {number} cadence
   */
  constructor(distance, duration, coords, cadence){
    super(distance, duration, coords);
    this.cadence = cadence;
    this.#calcPace();
    this.setDescription();
  }

  /**
   * Calcule workout pace
   * @returns {number}
   */
  #calcPace(){
    this.pace = this.duration/this.distance;
    return this.pace;
  }
}

/**
 * Cycling Class
 * @extends Workout
 */
class Cycling extends Workout{
  /** @property {string} name Workout name */
  name = 'cycling';

  /**
   * Creates a new Cycling object
   * @param {number} distance 
   * @param {number} duration 
   * @param {LatLng} coords - Leaflet Object LatLng
   * @param {number} gain
   */
  constructor(distance, duration, coords, gain){
    super(distance, duration, coords);
    this.gain = gain;
    this.#calcSpeed();
    this.setDescription();
  }

  /**
   * Calcule workout speed
   * @returns {number}
   */
  #calcSpeed(){
    this.speed = this.distance/(this.duration/60);
    return this.speed;
  }
}

/** [See App Class]{@link App} */
// @ts-ignore
const app = new App();

// function formatDateString(date){
//   const movDate = new Date(date);
//   const now = new Date();
//   const dateDiff = Math.trunc(Math.abs((now-movDate)/(1000*60*60*24)));
//   const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
//   const dateFormart = new Intl.DateTimeFormat('pt-BR', options).format(movDate);

//   if(dateDiff === 0)
//     return 'TODAY'
//   else if(dateDiff === 1)
//     return 'YESTERDAY'
//   else if(dateDiff &lt;= 7)
//     return `${dateDiff} days ago`;
//   else
//     return dateFormart;
// }</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="Cycling.html">Cycling</a></li><li><a href="Running.html">Running</a></li><li><a href="Workout.html">Workout</a></li></ul><h3>Global</h3><ul><li><a href="global.html#app">app</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Mon Oct 02 2023 21:53:31 GMT-0300 (Horário Padrão de Brasília)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
